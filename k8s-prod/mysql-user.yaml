spec:
  restartPolicy: OnFailure
  serviceAccountName: vault-auth
  containers:
    - name: mysql-user
      image: mysql:8.0
      imagePullPolicy: Always
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "Waiting for Vault secrets..."
          while [ ! -f /vault/secrets/db-cred ]; do sleep 1; done
          source /vault/secrets/db-cred
          echo "Waiting for MySQL to be ready..."
          until mysql -h mysql-svc -u root -p"$MYSQL_ROOT_PASSWORD" -e 'SELECT 1;' >/dev/null 2>&1; do sleep 1; done
          echo "Creating database user..."
          mysql -h mysql-svc -u root -p"$MYSQL_ROOT_PASSWORD" <<EOF
CREATE USER IF NOT EXISTS '$DB_USER'@'%' IDENTIFIED BY '$DB_PASSWORD';
GRANT ALL PRIVILEGES ON crud_app.* TO '$DB_USER'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;
EOF
          echo "User created successfully!"
      volumeMounts:
        - name: vault-ca
          mountPath: /vault/ca
          readOnly: true
  volumes:
    - name: vault-ca
      configMap:
        name: vault-ca-cert
